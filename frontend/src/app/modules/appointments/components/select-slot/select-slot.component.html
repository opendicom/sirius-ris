<span *ngIf="this.sharedProp.current_patient && this.sharedProp.current_imaging && this.sharedProp.current_modality && this.sharedProp.current_procedure; then thenBlockCurrentObj else elseBlockCurrentObj"></span>

<ng-template #thenBlockCurrentObj>
  <form class="form-element" [formGroup]="form" (ngSubmit)="onSubmit()">
    <div fxLayout="row" fxLayoutAlign="start start">
      <div class="input-wrapper divider"> <!-- start fxLayout wrapper -->
        <h2 class="form-title text-center underline-fail-alt">{{ 'APPOINTMENTS.FORM_INSERT.PATIENT.TITLE' | i18n }}</h2><br/>

        <span *ngIf="this.sharedProp.current_patient">
          <span *ngIf="this.sharedProp.current_patient.person">

            <div class="current-wrap">
              <!-- documents -->
              <div class="current-info">
                <small>{{ 'APPOINTMENTS.FORM_INSERT.PATIENT.DOCUMENTS' | i18n }}</small><br/>
                <span *ngFor="let current of this.sharedProp.current_patient.person.documents" >
                  <span matTooltip="{{ country_codes[current.doc_country_code].name }}" class="flag-icon flag-icon-{{ country_codes[current.doc_country_code].alpha_2 | lowercase }}"></span>&nbsp;
                  <span matTooltip="{{ document_types[current.doc_type] }}">
                    <span innerHTML="{{ current.document | highlighter : sharedProp.filter }}"></span>
                  </span>
                  <br/>
                </span>
              </div>

              <!-- names -->
              <div class="current-info">
                <small>{{ 'APPOINTMENTS.FORM_INSERT.PATIENT.FULL_NAME' | i18n }}</small><br/>
                <span class="current-firts">
                  <span>{{ this.sharedProp.current_patient.person.name_01 }}</span>

                  <span *ngIf="this.sharedProp.current_patient.person.name_02">
                    <span> {{ this.sharedProp.current_patient.person.name_02 }}</span>
                  </span>

                  <span> {{ this.sharedProp.current_patient.person.surname_01 }}</span>

                  <span *ngIf="this.sharedProp.current_patient.person.surname_02">
                    <span> {{ this.sharedProp.current_patient.person.surname_02 }}</span>
                  </span>
                </span>
              </div>

              <div class="clear"></div>
            </div>

            <div class="clear"></div>

            <div class="current-wrap">
              <!-- birth_date -->
              <div class="current-info">
                <small>{{ 'APPOINTMENTS.FORM_INSERT.PATIENT.BIRTH_DATE' | i18n }}</small><br/>
                <span class="current-firts">{{ this.sharedProp.current_patient.person.birth_date | date:"dd/MM/yyyy":"UTC" }}</span>
              </div>

              <!-- genre -->
              <div class="current-info text-center">
                <small>{{ 'APPOINTMENTS.FORM_INSERT.PATIENT.GENDER' | i18n }}</small><br/>
                <span [ngSwitch]="this.sharedProp.current_patient.person.gender" matTooltip="{{ gender_types[this.sharedProp.current_patient.person.gender] }}">
                  <span *ngSwitchCase="1"><mat-icon class="male">man</mat-icon></span>
                  <span *ngSwitchCase="2"><mat-icon class="female">woman</mat-icon></span>
                  <span *ngSwitchCase="3"><mat-icon class="other">wc</mat-icon></span>
                </span>
              </div>

              <!-- status -->
              <div class="current-info text-center">
                <small>{{ 'APPOINTMENTS.FORM_INSERT.PATIENT.STATUS' | i18n }}</small><br/>
                <span *ngIf="this.sharedProp.current_patient.status; then thenBlock else elseBlock"></span>
                <ng-template #thenBlock><mat-icon class="color-ok" matTooltip="{{ 'BRANCHES.LIST.STATUS.ACTIVE' | i18n }}">done</mat-icon></ng-template>
                <ng-template #elseBlock><mat-icon class="color-fail" matTooltip="{{ 'BRANCHES.LIST.STATUS.INACTIVE' | i18n }}">clear</mat-icon></ng-template>
              </div>

              <div class="clear"></div>
            </div>

            <!-- friendly password -->
            <div class="friendly-pass-wrap" *ngIf="this.sharedProp.current_friendly_pass !== ''">
              <div class="current-info">{{ 'APPOINTMENTS.FORM_INSERT.SUMMARY.RANDOM_PASSWORD' | i18n }}</div>
              <div class="current-info">
                <span class="friendly-pass">{{ this.sharedProp.current_friendly_pass }}</span>
              </div>
              <div class="clear"></div><hr class="dashed" />
              <small><strong>{{ 'APPOINTMENTS.FORM_INSERT.SUMMARY.PASSWORD_NOTE' | i18n }}</strong></small>
            </div>

          </span>
        </span>
      </div> <!-- end fxLayout wrapper -->

      <div class="input-wrapper"> <!-- start fxLayout wrapper -->
        <h2 class="form-title text-center underline-fail-alt">{{ 'APPOINTMENTS.FORM_INSERT.STUDY.TITLE' | i18n }}</h2><br/>

        <span *ngIf="this.sharedProp.current_imaging">
          <span *ngIf="this.sharedProp.current_imaging.organization && this.sharedProp.current_imaging.branch && this.sharedProp.current_imaging.service && currentModality">

            <div class="current-wrap">
              <!-- imaging and modality -->
              <div class="current-info">
                <small>{{ 'APPOINTMENTS.FORM_INSERT.STUDY.DOMAIN_HIERARCHY' | i18n }}</small><br/>
                <span class="current-firts">{{ this.sharedProp.current_imaging.organization.short_name + ' ► ' + this.sharedProp.current_imaging.branch.short_name + ' ► ' + this.sharedProp.current_imaging.service.name }}</span>
              </div>

              <div class="clear"></div>
            </div>

            <div class="clear"></div>

            <div class="current-wrap">
              <!-- procedure -->
              <div class="current-info text-center">
                <small>{{ 'APPOINTMENTS.FORM_INSERT.STUDY.PROCEDURE' | i18n }}</small><br/>
                <span class="badge-alt">
                  <span>{{ this.sharedProp.current_procedure.name }}</span>
                </span>
              </div>

              <!-- modality -->
              <div class="current-info text-center">
                <small>{{ 'APPOINTMENTS.FORM_INSERT.STUDY.MODALITY' | i18n }}</small><br/>
                <span class="badge" matTooltip="{{ currentModality.code_meaning }}">
                  <span>{{ currentModality.code_value }}</span>
                </span>
              </div>

              <!-- informed_consent -->
              <div class="current-info text-center">
                <small>{{ 'APPOINTMENTS.FORM_INSERT.STUDY.REQUIRES_INFORMED_CONSENT' | i18n }}</small><br/>
                <span *ngIf="this.sharedProp.current_procedure.informed_consent; then thenBlock else elseBlock"></span>
                <ng-template #thenBlock><mat-icon class="color-ok" matTooltip="{{ 'PROCEDURES.FORM.YES' | i18n }}">done</mat-icon></ng-template>
                <ng-template #elseBlock><mat-icon class="color-fail" matTooltip="{{ 'PROCEDURES.FORM.NO' | i18n }}">clear</mat-icon></ng-template>
              </div>

              <div class="clear"></div>
            </div>

          </span>
        </span>
      </div> <!-- end fxLayout wrapper -->

    </div>

    <hr class="dashed"/>

    <div class="calendar-container divider-alt">
      <!-- FullCalendar Datepicker -->
      <mat-form-field appearance="fill" id="invisible-datepicker" class="invisible-datepicker large" (click)="picker.open()">
        <mat-label>{{ 'ACTION.SELECT_DATE' | i18n }}</mat-label>
        <input matInput [matDatepicker]="picker" [min]="minDate" [max]="maxDate" (keydown)="false" (dateChange)="onChangeDate($event)">
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
      </mat-form-field>

      <!-- FullCalendar -->
      <full-calendar #calendar [options]="calendarOptions"></full-calendar>

      <br/>

      <button mat-flat-button type="button" appearance="fill" (click)="setResources('ALL')">{{ 'APPOINTMENTS.FORM_UPDATE.TAB_SLOT.ALL_EQUIPMENTS_BUTTON' | i18n }}</button>
      <span *ngFor="let currentResource of calendarResources">
        <button mat-flat-button type="button" appearance="fill" color="accent" (click)="setResources(currentResource.id)">{{ currentResource.title.split('|')[0] }}</button>
      </span>
      <br/>
    </div>

    <!-- Slot info container -->
    <div class="slot-container">
      <h4 class="underline-ok-alt">{{ 'APPOINTMENTS.FORM_UPDATE.TAB_SLOT.EQUIPMENT_DATA_TITLE' | i18n }}</h4>

      <div class="current-wrap" [class.unselected]="selectedEquipment == undefined">
        <!-- selected equipment -->
        <div class="current-info">
          <small>{{ 'APPOINTMENTS.FORM_UPDATE.TAB_SLOT.SELECTED_EQUIPMENT' | i18n }}</small><br/>
          <span *ngIf="selectedEquipment == undefined; then thenBlockEquipment else elseBlockEquipment"></span>
          <ng-template #thenBlockEquipment><span class="current-firts">{{ 'BRANCHES.LIST.NO_DATA' | i18n }}</span></ng-template>
          <ng-template #elseBlockEquipment><span class="current-firts">{{ selectedEquipment.details.name }}</span></ng-template>
        </div>
        <div class="clear"></div>
      </div>

      <div class="current-wrap" [class.unselected]="selectedEquipment == undefined">
        <!-- selected equipment duration -->
        <div class="current-info">
          <small>{{ 'APPOINTMENTS.FORM_UPDATE.TAB_SLOT.PROCEDURE_DURATION' | i18n }}</small><br/>
          <span *ngIf="selectedEquipment == undefined; then thenBlockEquipmentDuration else elseBlockEquipmentDuration"></span>
          <ng-template #thenBlockEquipmentDuration><span class="current-firts">{{ 'BRANCHES.LIST.NO_DATA' | i18n }}</span></ng-template>
          <ng-template #elseBlockEquipmentDuration><span class="current-firts">{{ selectedEquipment.duration }} <small>min.</small></span></ng-template>
        </div>
        <div class="clear"></div>
      </div>

      <br/><hr class="dashed" /><br/>

      <h4 class="underline-ok-alt">{{ 'APPOINTMENTS.FORM_UPDATE.TAB_SLOT.APPOINTMENT_DATA_TITLE' | i18n }}</h4>

      <div class="current-wrap" [class.unselected]="selectedStart == undefined">
        <!-- selected date -->
        <div class="current-info">
          <small>{{ 'APPOINTMENTS.FORM_UPDATE.TAB_SLOT.APPOINTMENT_DATE' | i18n }}</small><br/>
          <span *ngIf="selectedStart == undefined; then thenBlockDate else elseBlockDate"></span>
          <ng-template #thenBlockDate><span class="current-firts">{{ 'BRANCHES.LIST.NO_DATA' | i18n }}</span></ng-template>
          <ng-template #elseBlockDate><span class="current-firts">{{ selectedStart | date:"dd/MM/yyyy":"UTC" }}</span></ng-template>
        </div>
        <div class="clear"></div>
      </div>

      <!-- selected start -->
      <div class="current-wrap" [class.unselected]="selectedStart == undefined">
        <div class="current-info">
          <small>{{ 'APPOINTMENTS.FORM_UPDATE.TAB_SLOT.START_TIME' | i18n }}</small><br/>
          <span *ngIf="selectedStart == undefined; then thenBlockStart else elseBlockStart"></span>
          <ng-template #thenBlockStart><span class="current-firts">{{ 'BRANCHES.LIST.NO_DATA' | i18n }}</span></ng-template>
          <ng-template #elseBlockStart><span class="current-firts">{{ selectedStart | date:"HH:mm":"UTC" }}</span></ng-template>
        </div>
        <div class="clear"></div>
      </div>

      <!-- selected end -->
      <div class="current-wrap" [class.unselected]="selectedEnd == undefined">
        <div class="current-info">
          <small>{{ 'APPOINTMENTS.FORM_UPDATE.TAB_SLOT.END_TIME' | i18n }}</small><br/>
          <span *ngIf="selectedEnd == undefined; then thenBlockEnd else elseBlockEnd"></span>
          <ng-template #thenBlockEnd><span class="current-firts">{{ 'BRANCHES.LIST.NO_DATA' | i18n }}</span></ng-template>
          <ng-template #elseBlockEnd><span class="current-firts">{{ selectedEnd | date:"HH:mm":"UTC" }}</span></ng-template>
        </div>

        <div class="clear"></div>
      </div>

      <br/><hr class="dashed" /><br/>

      <div class="text-center">
        <h4>{{ 'ACTION.URGENCY' | i18n }}</h4>
        <mat-radio-group color="primary" formControlName="urgency" (change)="onCheckUrgency($event)">
          <mat-radio-button value="true">{{ 'PROCEDURES.FORM.YES' | i18n }}</mat-radio-button>
          <mat-radio-button value="false">{{ 'PROCEDURES.FORM.NO' | i18n }}</mat-radio-button>
        </mat-radio-group>
      </div>

      <br/><hr class="dashed" /><br/>

      <div *ngIf="selectedEquipment && selectedStart && selectedEnd && selectedSlot" class="text-center">
        <button mat-flat-button type="button" color="accent" (click)="onDelete();"><mat-icon>delete_forever</mat-icon>&nbsp; {{ 'ACTION.DELETE_SELECTION' | i18n }}</button>
      </div>

      <!-- 1: Superusuario, 2: Administrador, Concesiones: [23: Sobreagenda] -->
      <div class="text-center" *ngIf="sharedProp.userLogged.permissions[0].role == 1 || sharedProp.userLogged.permissions[0].role == 2 || (sharedProp.userLogged.permissions[0].concession && sharedFunctions.checkConcessions(sharedProp, [23]))" >
        <br/><hr class="dashed" /><br/>
        <mat-checkbox color="primary" (change)="onCheckOverbooking($event)">{{ 'APPOINTMENTS.FORM_UPDATE.TAB_SLOT.ALLOW_OVERBOOKING' | i18n }}</mat-checkbox>
      </div>
      
      <br/>

    </div>

    <div class="clear"></div>

    <div class="action-wrapper"fxLayout="row" fxLayoutAlign="end center">
      <div> <!-- start fxLayout wrapper -->
        <button mat-flat-button type="button" (click)="onCancel();">{{ 'COMMON.CANCEL' | i18n | uppercase }}</button>
        <button mat-flat-button type="button" color="accent" routerLink="/appointments/select_procedure">◄&nbsp; {{ 'APPOINTMENTS.SELECT_PROCEDURE.BACK_BUTTON' | i18n }}</button>
        <button mat-flat-button type="submit" color="primary" [disabled]="selectedEquipment && selectedStart && selectedEnd && selectedSlot ? undefined : true">{{ 'APPOINTMENTS.SELECT_PROCEDURE.NEXT_BUTTON' | i18n }} &nbsp;►</button>
      </div> <!-- end fxLayout wrapper -->
    </div>
  </form>
</ng-template>

<ng-template #elseBlockCurrentObj>
  <form class="form-element text-center">
    <br/>
    <mat-icon class="search-off-icon">search_off</mat-icon>

    <br/><br/><hr class="dashed" /><br/>
    <h4>{{ 'APPOINTMENTS.SELECT_SLOT.NO_DATA_ERROR' | i18n }}</h4>

    <button mat-flat-button type="button" (click)="onCancel();">{{ 'APPOINTMENTS.FORM_INSERT.ERROR.BACK_TO_LIST' | i18n }}</button>

    <br/><br/>
  </form>
</ng-template>
